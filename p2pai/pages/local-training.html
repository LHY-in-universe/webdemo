<!DOCTYPE html>
<html lang="en" data-i18n-title="p2pai.dashboard.training.local.title">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Model Training</title>
    <!-- ==================== é˜²ç™½é—ªè„šæœ¬ ==================== -->
    <script>
        (function() {
            'use strict';
            try {
                const savedTheme = localStorage.getItem('theme');
                const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                const theme = savedTheme || (prefersDark ? 'dark' : 'light');
                
                document.documentElement.setAttribute('data-theme', theme);
                
                if (theme === 'dark') {
                    document.documentElement.style.backgroundColor = '#1f2937';
                    document.documentElement.style.color = '#f9fafb';
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.style.backgroundColor = '#ffffff';
                    document.documentElement.style.color = '#1f2937';
                    document.documentElement.classList.remove('dark');
                }
                
                console.log('ğŸ¨ Anti-flash: Theme set to', theme);
                
            } catch (error) {
                console.warn('âš ï¸ Anti-flash script failed:', error);
                document.documentElement.setAttribute('data-theme', 'dark');
                document.documentElement.style.backgroundColor = '#1f2937';
                document.documentElement.style.color = '#f9fafb';
                document.documentElement.classList.add('dark');
            }
        })();
    </script>
    
    <!-- ==================== å…³é”®CSSé¢„åŠ è½½ ==================== -->
    <style>
        /* é˜²æ­¢ç™½é—ªçš„å…³é”®æ ·å¼ */
        html[data-theme="dark"] {
            background-color: #1f2937 !important;
            color: #f9fafb !important;
        }
        html[data-theme="light"] {
            background-color: #ffffff !important;
            color: #1f2937 !important;
        }
        
        html[data-theme="dark"] body {
            background-color: #1f2937 !important;
            color: #f9fafb !important;
        }
        html[data-theme="light"] body {
            background-color: #ffffff !important;
            color: #1f2937 !important;
        }
        
        /* æ·±è‰²æ¨¡å¼ä¸‹å¡ç‰‡æ ·å¼ä¿®å¤ */
        html[data-theme="dark"] .card {
            background-color: #1f2937 !important;
            border-color: #4b5563 !important;
        }
        
        /* æ·±è‰²æ¨¡å¼ä¸‹çš„æ–‡æœ¬é¢œè‰²ä¿®å¤ */
        html[data-theme="dark"] .text-gray-900 {
            color: #f9fafb !important;
        }
        
        html[data-theme="dark"] .text-gray-700 {
            color: #d1d5db !important;
        }
        
        html[data-theme="dark"] .text-gray-600 {
            color: #9ca3af !important;
        }
        
        /* æ·±è‰²æ¨¡å¼ä¸‹çš„è¡¨å•å…ƒç´  */
        html[data-theme="dark"] select,
        html[data-theme="dark"] input[type="number"],
        html[data-theme="dark"] input[type="range"] {
            background-color: #374151 !important;
            border-color: #4b5563 !important;
            color: #f9fafb !important;
        }
        
        html[data-theme="dark"] .bg-gray-200 {
            background-color: #4b5563 !important;
        }
        
        /* æ·±è‰²æ¨¡å¼ä¸‹çš„æŒ‰é’®æ ·å¼ - æœ€é«˜ä¼˜å…ˆçº§ */
        [data-theme="dark"] button.bg-gray-600,
        [data-theme="dark"] #startTraining {
            background-color: #374151 !important;
            border: 1px solid #4b5563 !important;
            color: #f9fafb !important;
        }
        
        [data-theme="dark"] button.bg-gray-600:hover,
        [data-theme="dark"] #startTraining:hover {
            background-color: #4b5563 !important;
        }
        
        /* è¿”å›æŒ‰é’®æ ·å¼ä¿®å¤ */
        [data-theme="dark"] .homepage-return-btn {
            background-color: #374151 !important;
            border: 1px solid #4b5563 !important;
            color: #f9fafb !important;
        }
        
        [data-theme="dark"] .homepage-return-btn:hover {
            background-color: #4b5563 !important;
        }
        
        [data-theme="dark"] .homepage-return-btn svg {
            color: #f9fafb !important;
        }
        
        /* å¯¼èˆªæ è¿”å›æŒ‰é’®æ ·å¼ä¿®å¤ */
        [data-theme="dark"] .navbar-brand button {
            background-color: #374151 !important;
            border: 1px solid #4b5563 !important;
            color: #f9fafb !important;
        }
        
        [data-theme="dark"] .navbar-brand button:hover {
            background-color: #4b5563 !important;
            color: #f9fafb !important;
        }
        
        [data-theme="dark"] .navbar-brand button svg {
            color: #f9fafb !important;
        }
        
        /* å¹³æ»‘è¿‡æ¸¡ */
        html, body {
            transition: background-color 0.3s ease, color 0.3s ease !important;
        }
    </style>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="../../shared/css/unified-styles.css?v=1756673001">
    
</head>
<body class="module-background theme-transition">
    <!-- Navigation -->
    <nav class="navbar fade-in-up">
        <div class="max-w-4xl mx-auto flex items-center justify-between">
            <div class="navbar-brand">
                <button onclick="goBack()" class="mr-4 p-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-lg transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                </button>
                <span data-i18n="p2pai.dashboard.training.local.title">æœ¬åœ°æ¨¡å‹è®­ç»ƒ</span>
            </div>
            
            <div class="navbar-nav">
                <span id="userInfo" class="text-sm text-gray-600"></span>
                <button class="theme-toggle" title="Toggle Theme">
                    <span data-theme-icon>ğŸŒ™</span>
                </button>
                <button class="language-toggle" title="Switch Language">EN</button>
                <button onclick="logout()" class="btn btn-secondary text-sm btn-click">
                    <span data-i18n="common.logout">é€€å‡ºç™»å½•</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-4xl mx-auto px-6 py-8 content-area">
        <!-- Training Configuration -->
        <div class="mb-8">
            <div class="card p-6 fade-in-up delay-1">
                <h2 class="text-2xl font-bold text-gray-900 mb-6" data-i18n="p2pai.dashboard.training.local.trainingConfig">è®­ç»ƒé…ç½®</h2>
                
                <div class="grid md:grid-cols-2 gap-6">
                    <!-- Model Configuration -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-4" data-i18n="p2pai.dashboard.training.local.modelConfig">æ¨¡å‹é…ç½®</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="p2pai.dashboard.training.local.modelType">æ¨¡å‹ç±»å‹</label>
                                <select id="modelType" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-transparent">
                                    <option value="cnn" data-i18n="p2pai.dashboard.training.local.cnn">å·ç§¯ç¥ç»ç½‘ç»œ (CNN)</option>
                                    <option value="rnn" data-i18n="p2pai.dashboard.training.local.rnn">å¾ªç¯ç¥ç»ç½‘ç»œ (RNN)</option>
                                    <option value="transformer" data-i18n="p2pai.dashboard.training.local.transformer">Transformer</option>
                                    <option value="mlp" data-i18n="p2pai.dashboard.training.local.mlp">å¤šå±‚æ„ŸçŸ¥æœº (MLP)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="p2pai.dashboard.training.local.learningRate">å­¦ä¹ ç‡</label>
                                <input type="number" id="learningRate" value="0.001" step="0.0001" min="0.0001" max="1"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-transparent">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="p2pai.dashboard.training.local.batchSize">æ‰¹æ¬¡å¤§å°</label>
                                <select id="batchSize" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-transparent">
                                    <option value="16">16</option>
                                    <option value="32" selected>32</option>
                                    <option value="64">64</option>
                                    <option value="128">128</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="p2pai.dashboard.training.local.epochs">è®­ç»ƒè½®æ•°</label>
                                <input type="number" id="epochs" value="100" min="1" max="1000"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-transparent">
                            </div>
                        </div>
                    </div>

                    <!-- Dataset Configuration -->
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-4" data-i18n="p2pai.dashboard.training.local.datasetConfig">æ•°æ®é›†é…ç½®</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="p2pai.dashboard.training.local.selectDataset">é€‰æ‹©æ•°æ®é›†</label>
                                <select id="dataset" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-transparent">
                                    <option value="dataset1" data-i18n="p2pai.dashboard.training.local.dataset1">è®­ç»ƒé›†_v1.csv (15,842æ¡)</option>
                                    <option value="dataset2" data-i18n="p2pai.dashboard.training.local.dataset2">è®­ç»ƒé›†_v2.csv (23,567æ¡)</option>
                                    <option value="dataset3" data-i18n="p2pai.dashboard.training.local.dataset3">å›¾åƒæ•°æ®é›† (8,934å¼ )</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="p2pai.dashboard.training.local.validationSplit">éªŒè¯é›†æ¯”ä¾‹</label>
                                <input type="range" id="validationSplit" min="0.1" max="0.3" step="0.05" value="0.2"
                                       class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider">
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>10%</span>
                                    <span id="validationValue">20%</span>
                                    <span>30%</span>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="p2pai.dashboard.training.local.dataAugmentation">æ•°æ®å¢å¼º</label>
                                <div class="space-y-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="augmentRotation" class="h-4 w-4 text-gray-600 focus:ring-gray-500 border-gray-300 rounded">
                                        <span class="ml-2 text-sm text-gray-600" data-i18n="p2pai.dashboard.training.local.rotation">æ—‹è½¬</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="augmentFlip" class="h-4 w-4 text-gray-600 focus:ring-gray-500 border-gray-300 rounded">
                                        <span class="ml-2 text-sm text-gray-600" data-i18n="p2pai.dashboard.training.local.flip">ç¿»è½¬</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="augmentNoise" class="h-4 w-4 text-gray-600 focus:ring-gray-500 border-gray-300 rounded">
                                        <span class="ml-2 text-sm text-gray-600" data-i18n="p2pai.dashboard.training.local.noise">å™ªå£°</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Training Controls -->
                <div class="mt-8 flex justify-center">
                    <button id="startTraining" onclick="startTraining()" 
                            class="bg-gray-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-gray-700 transition-all duration-200 transform hover:scale-105 shadow-lg">
                        <span data-i18n="p2pai.dashboard.training.local.startTraining">å¼€å§‹è®­ç»ƒ</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Training Progress -->
        <div class="grid md:grid-cols-2 gap-8 mb-8">
            <!-- Training Metrics Chart -->
            <div class="card p-6 fade-in-up delay-1">
                <h3 class="text-lg font-semibold text-gray-900 mb-4" data-i18n="p2pai.dashboard.training.local.trainingMetrics">è®­ç»ƒæŒ‡æ ‡</h3>
                <div class="h-64">
                    <canvas id="metricsChart"></canvas>
                </div>
            </div>

            <!-- Loss Chart -->
            <div class="card p-6 fade-in-up delay-1">
                <h3 class="text-lg font-semibold text-gray-900 mb-4" data-i18n="p2pai.dashboard.training.local.lossFunction">æŸå¤±å‡½æ•°</h3>
                <div class="h-64">
                    <canvas id="lossChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Training Status -->
        <div class="grid md:grid-cols-3 gap-6 mb-8">
            <!-- Current Status -->
            <div class="card p-6 fade-in-up delay-1">
                <h3 class="text-lg font-semibold text-gray-900 mb-4" data-i18n="p2pai.dashboard.training.local.trainingStatus">è®­ç»ƒçŠ¶æ€</h3>
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-gray-600" data-i18n="p2pai.dashboard.training.local.currentStatus">å½“å‰çŠ¶æ€</span>
                        <span id="trainingStatus" class="font-medium text-gray-500" data-i18n="p2pai.dashboard.training.local.notStarted">â— æœªå¼€å§‹</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-600" data-i18n="p2pai.dashboard.training.local.currentEpoch">å½“å‰è½®æ•°</span>
                        <span id="currentEpoch" class="font-medium text-gray-600">0 / 100</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-600" data-i18n="p2pai.dashboard.training.local.trainingTime">è®­ç»ƒæ—¶é—´</span>
                        <span id="trainingTime" class="font-medium text-gray-600">00:00:00</span>
                    </div>
                </div>

                <!-- Progress Bar -->
                <div class="mt-4">
                    <div class="flex justify-between text-sm text-gray-600 mb-1">
                        <span data-i18n="p2pai.dashboard.training.local.progress">è¿›åº¦</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="progressBar" class="bg-gray-600 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Performance Metrics -->
            <div class="card p-6 fade-in-up delay-1">
                <h3 class="text-lg font-semibold text-gray-900 mb-4" data-i18n="p2pai.dashboard.training.local.performanceMetrics">æ€§èƒ½æŒ‡æ ‡</h3>
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-gray-600" data-i18n="p2pai.dashboard.training.local.currentAccuracy">å½“å‰å‡†ç¡®ç‡</span>
                        <span id="currentAccuracy" class="font-medium text-gray-600">0.00%</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-600" data-i18n="p2pai.dashboard.training.local.currentLoss">å½“å‰æŸå¤±</span>
                        <span id="currentLoss" class="font-medium text-gray-600">0.0000</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-600" data-i18n="p2pai.dashboard.training.local.bestAccuracy">æœ€ä½³å‡†ç¡®ç‡</span>
                        <span id="bestAccuracy" class="font-medium text-gray-600">0.00%</span>
                    </div>
                </div>
            </div>

            <!-- Resource Usage -->
            <div class="card p-6 fade-in-up delay-1">
                <h3 class="text-lg font-semibold text-gray-900 mb-4" data-i18n="p2pai.dashboard.training.local.resourceUsage">èµ„æºä½¿ç”¨</h3>
                <div class="space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-gray-600" data-i18n="p2pai.dashboard.training.local.cpuUsage">CPUä½¿ç”¨ç‡</span>
                        <span id="cpuUsage" class="font-medium text-gray-600">0%</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-600" data-i18n="p2pai.dashboard.training.local.memoryUsage">å†…å­˜ä½¿ç”¨</span>
                        <span id="memoryUsage" class="font-medium text-gray-600">0 MB</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-gray-600" data-i18n="p2pai.dashboard.training.local.gpuUsage">GPUä½¿ç”¨ç‡</span>
                        <span id="gpuUsage" class="font-medium text-gray-600">N/A</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Training Logs -->
        <div class="card p-6 fade-in-up delay-1">
            <h3 class="text-lg font-semibold text-gray-900 mb-4" data-i18n="p2pai.dashboard.training.local.trainingLogs">è®­ç»ƒæ—¥å¿—</h3>
            <div id="trainingLogs" class="bg-black text-green-400 p-4 rounded-lg h-64 overflow-y-auto font-mono text-sm">
                <div data-i18n="p2pai.dashboard.training.local.waitingToStart">ç­‰å¾…å¼€å§‹è®­ç»ƒ...</div>
            </div>
        </div>
    </div>

    <!-- Back to Home Button -->
    <button class="homepage-return-btn btn-click" onclick="goHome()" title="Back to Home">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
        </svg>
    </button>

    <script src="../../shared/js/navigation-unified.js?v=20250902"></script>
    <script src="../../shared/js/theme-manager-unified.js?v=20250827"></script>
    <script src="../../shared/js/i18n-manager.js?v=20250905"></script>
    <script>
        // Ensure goHome function is available (fallback implementation)
        window.goHome = window.goHome || function() {
            console.log('ğŸ  goHome function called');
            window.location.href = '/homepage/index.html';
        };
                let trainingInterval;
        let startTime;
        let currentEpoch = 0;
        let totalEpochs = 100;
        let isTraining = false;
        let isPaused = false;
        let metricsChart, lossChart;

        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts();
            updateValidationDisplay();
            
            // Validation split slider event
            document.getElementById('validationSplit').addEventListener('input', updateValidationDisplay);
        });

        function initializeCharts() {
            // Training metrics chart
            const metricsCtx = document.getElementById('metricsChart').getContext('2d');
            metricsChart = new Chart(metricsCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: document.querySelector('[data-i18n="p2pai.dashboard.training.local.accuracy"]')?.textContent || 'Accuracy',
                        data: [],
                        borderColor: '#4b5563',
                        backgroundColor: 'rgba(75, 85, 99, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1
                        }
                    }
                }
            });

            // æŸå¤±å‡½æ•°å›¾è¡¨
            const lossCtx = document.getElementById('lossChart').getContext('2d');
            lossChart = new Chart(lossCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: document.querySelector('[data-i18n="p2pai.dashboard.training.local.trainLoss"]')?.textContent || 'Training Loss',
                        data: [],
                        borderColor: '#6b7280',
                        backgroundColor: 'rgba(107, 114, 128, 0.1)',
                        tension: 0.4
                    }, {
                        label: document.querySelector('[data-i18n="p2pai.dashboard.training.local.validationLoss"]')?.textContent || 'Validation Loss',
                        data: [],
                        borderColor: '#9ca3af',
                        backgroundColor: 'rgba(156, 163, 175, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updateValidationDisplay() {
            const value = document.getElementById('validationSplit').value;
            document.getElementById('validationValue').textContent = (value * 100).toFixed(0) + '%';
        }

        function startTraining() {
            // Get configuration
            totalEpochs = parseInt(document.getElementById('epochs').value);
            currentEpoch = 0;
            startTime = Date.now();
            isTraining = true;
            isPaused = false;

            // Update UI status
            document.getElementById('startTraining').disabled = true;
            document.getElementById('startTraining').innerHTML = '<span data-i18n="p2pai.dashboard.training.local.training">Training...</span>';
            
            const trainingStatusElement = document.getElementById('trainingStatus');
            trainingStatusElement.innerHTML = '<span class="text-green-600" data-i18n="p2pai.dashboard.training.local.trainingStatus">â— Training</span>';
            trainingStatusElement.setAttribute('data-i18n', 'p2pai.dashboard.training.local.training');

            // Clear charts
            metricsChart.data.labels = [];
            metricsChart.data.datasets[0].data = [];
            lossChart.data.labels = [];
            lossChart.data.datasets[0].data = [];
            lossChart.data.datasets[1].data = [];
            metricsChart.update();
            lossChart.update();

            // Add initial logs
            addTrainingLog('Starting training...');
            addTrainingLog(`Model type: ${document.getElementById('modelType').options[document.getElementById('modelType').selectedIndex].text}`);
            addTrainingLog(`Learning rate: ${document.getElementById('learningRate').value}`);
            addTrainingLog(`Batch size: ${document.getElementById('batchSize').value}`);
            addTrainingLog(`Total epochs: ${totalEpochs}`);

            // Start training loop
            trainingInterval = setInterval(updateTraining, 2000); // Update every 2 seconds
        }

        function updateTraining() {
            currentEpoch++;
            
            // Simulate training metrics
            const accuracy = Math.min(0.95, 0.1 + (currentEpoch / totalEpochs) * 0.85 + (Math.random() - 0.5) * 0.1);
            const trainLoss = Math.max(0.01, 2.5 - (currentEpoch / totalEpochs) * 2.4 + (Math.random() - 0.5) * 0.3);
            const valLoss = Math.max(0.02, 2.6 - (currentEpoch / totalEpochs) * 2.5 + (Math.random() - 0.5) * 0.4);

            // Update charts
            metricsChart.data.labels.push(`Epoch ${currentEpoch}`);
            metricsChart.data.datasets[0].data.push(accuracy);
            lossChart.data.labels.push(`Epoch ${currentEpoch}`);
            lossChart.data.datasets[0].data.push(trainLoss);
            lossChart.data.datasets[1].data.push(valLoss);

            // Limit chart data points
            if (metricsChart.data.labels.length > 20) {
                metricsChart.data.labels.shift();
                metricsChart.data.datasets[0].data.shift();
                lossChart.data.labels.shift();
                lossChart.data.datasets[0].data.shift();
                lossChart.data.datasets[1].data.shift();
            }

            metricsChart.update('none');
            lossChart.update('none');

            // Update status display
            document.getElementById('currentEpoch').textContent = `${currentEpoch} / ${totalEpochs}`;
            document.getElementById('currentAccuracy').textContent = (accuracy * 100).toFixed(2) + '%';
            document.getElementById('currentLoss').textContent = trainLoss.toFixed(4);
            
            const bestAcc = Math.max(...metricsChart.data.datasets[0].data);
            document.getElementById('bestAccuracy').textContent = (bestAcc * 100).toFixed(2) + '%';

            // Update progress bar
            const progress = (currentEpoch / totalEpochs) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressPercent').textContent = progress.toFixed(1) + '%';

            // Update training time
            const elapsed = Date.now() - startTime;
            document.getElementById('trainingTime').textContent = formatTime(elapsed);

            // Simulate resource usage
            document.getElementById('cpuUsage').textContent = (60 + Math.random() * 30).toFixed(1) + '%';
            document.getElementById('memoryUsage').textContent = (1200 + Math.random() * 300).toFixed(0) + ' MB';
            document.getElementById('gpuUsage').textContent = (75 + Math.random() * 20).toFixed(1) + '%';

            // Add training logs
            if (currentEpoch % 5 === 0) {
                addTrainingLog(`Epoch ${currentEpoch}/${totalEpochs} - Accuracy: ${(accuracy * 100).toFixed(2)}% - Loss: ${trainLoss.toFixed(4)}`);
            }

            // Check if training is completed
            if (currentEpoch >= totalEpochs) {
                completeTraining();
            }
        }

        function completeTraining() {
            isTraining = false;
            clearInterval(trainingInterval);
            
            document.getElementById('startTraining').disabled = false;
            document.getElementById('startTraining').innerHTML = '<span data-i18n="p2pai.dashboard.training.local.startTraining">å¼€å§‹è®­ç»ƒ</span>';
            
            const trainingStatusElement = document.getElementById('trainingStatus');
            trainingStatusElement.innerHTML = '<span class="text-green-600" data-i18n="p2pai.dashboard.training.local.completed">â— Training Completed</span>';
            trainingStatusElement.setAttribute('data-i18n', 'p2pai.dashboard.training.local.completed');
            
            const completedText = window.i18nManager ? window.i18nManager.getTranslation('p2pai.dashboard.training.local.trainingCompleted') || 'Training completed!' : 'Training completed!';
            const finalAccuracyText = window.i18nManager ? window.i18nManager.getTranslation('p2pai.dashboard.training.local.finalAccuracy') || 'Final accuracy' : 'Final accuracy';
            const totalTimeText = window.i18nManager ? window.i18nManager.getTranslation('p2pai.dashboard.training.local.totalTime') || 'Total time' : 'Total time';
            
            addTrainingLog(completedText);
            addTrainingLog(`${finalAccuracyText}: ${document.getElementById('bestAccuracy').textContent}`);
            addTrainingLog(`${totalTimeText}: ${document.getElementById('trainingTime').textContent}`);
        }

        function addTrainingLog(message) {
            const logsContainer = document.getElementById('trainingLogs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${timestamp}] ${message}`;
            logsContainer.appendChild(logEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        function formatTime(milliseconds) {
            const seconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            
            return `${hours.toString().padStart(2, '0')}:${(minutes % 60).toString().padStart(2, '0')}:${(seconds % 60).toString().padStart(2, '0')}`;
        }

        function goBack() {
            if (isTraining && !confirm('Training is in progress, are you sure you want to go back?')) {
                return;
            }
            window.location.href = '/p2pai/pages/client-dashboard.html';
        }

        function logout() {
            if (isTraining && !confirm('Training is in progress, are you sure you want to logout?')) {
                return;
            }
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            localStorage.removeItem('loginTime');
            window.location.href = '/p2pai/pages/login.html';
        }
    </script>
</body>
</html>